# 操作系统原理第三章：操作系统的物理内存管理
## 操作系统的内存分层体系结构：
![image](https://user-images.githubusercontent.com/57695072/126886505-f25537b1-cedc-4dba-87ac-8af1aea608c2.png)

主要分成三大块，分别是寄存器和cache，主存，磁盘，三者对于cpu而言的访问读取速度是从低到高的。

其中计算机CPU内部的寄存器，L1，L2，L3 cache都是又cpu自动管理的，内存和磁盘都是又操作系统进行管理的。

> 操作系统不可以直接访问到cpu内部的寄存器和cache。

## 内存管理目的

![image](https://user-images.githubusercontent.com/57695072/126886504-91328f53-61ac-47ed-86ac-a011bea5f074.png)

1. 抽象
2. 保护
3. 共享
4. 虚拟

> 操作系统中虚拟内存的作用：当系统主存不够所有的应用程序使用的时候，操作系统会将目前特别急需内存的程序放到主存中，将暂时不是特别需要使用的数据或是急需内存的程序放到硬盘中去(这里可以用同步程序和异步程序来举个例子，同步程序就是特别需要内存的程序，异步等待调用的程序就是可以放到硬盘中的程序)。

> 在操作系统加载程序的时候，会有一个loader程序应用将磁盘上的程序加载到内存中。
## 地址空间的定义

- 地址空间 —— 硬件支持的地址空间( address : [0, Max_sys] )
- 地址空间 —— 一个运行在程序所拥有的的内存范围( address : [0, Max_prog] )

## cpu运行一条指令的过程
1. cpu的alu向cpu中的mmu(内存控制器)发出一个带国际地址的查地址指令以获取内存指令的物理地址。
2. mmu查找逻辑地址和物理地址的关系映射表(存储在cpu内部的表)，如果没有找到则回去内存中寻找
3. cpu控制器获取到物理地址后想主存发起请求。
4. 主存吧内存中的数据通过总线发送给cpu
> 在这整个过程中，
> 操作系统所起的作用是建立起了一张提供给cpu的从逻辑地址到物理地址的映射表。

## 内存碎片的问题
1. 外部碎片
2. 内部碎片

## 内存的动态分配方法
1. 第一匹配分配(首次适配分配)
  - 优点：
    1. 分配算法的实现简单
  - 缺点：
    1. 容易产生外碎片
2. 最优适配分配
  - 优点：
    1. 按尺寸从小到大分配
    2. 算法实现比较简单
    3. 当大部分分配的内存都是小尺寸的时候高效
  - 缺点：
    1. 分配慢
    2. 会产生很多没有用处的微小碎片
3. 最差适配分配
  - 优点：
    1. 按尺寸从大到小分配
    2. 部分分配的内存都是大尺寸的时候高效
  - 缺点：
    1. 分配慢
    2. 容易拆分大尺寸的内存空间使得剩余的小内存空间无法得到再次使用

## 内存碎片的整理方法
1. 压缩式整理：重置压缩内存，将不同程序运行的内存地址空间之间空闲内存段给压缩出来，减少程序的内存浪费
  - 带来的问题：什么时候内存需要重置压缩？
2. 交换式整理：利用操作系统的swap，当程序处于过起或等待的时候，将程序搬移到硬盘上去，将急需要内存的程序放到主存中来
  - 带来的问题：哪些程序应该被回收？
